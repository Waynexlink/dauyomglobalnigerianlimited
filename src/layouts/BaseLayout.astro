---
import { ClientRouter } from "astro:transitions";
import type { GetImageResult } from "astro";
import client from "@data/client.json";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import "@styles/root.less";

// Define a type for images from the content collection
type ContentImage = {
  src: string;
  width: number;
  height: number;
  format: "png" | "jpg" | "jpeg" | "tiff" | "webp" | "gif" | "svg" | "avif";
};

// Create a union type for preloadedImage
type PreloadedImage = GetImageResult | ContentImage;

interface Props {
  title: string;
  description: string;
  preloadedImage?: PreloadedImage; // optional - passing a preloadedImage to BaseLayout will 1. preload the image and 2. use the image for og socials tags in the <head>
}

const { description, title, preloadedImage } = Astro.props as Props;

// ✅ Create absolute URL for OG image (required for social media)
const ogImageUrl = preloadedImage
  ? new URL(preloadedImage.src, Astro.site || `https://${client.domain}`).href
  : null;
---

<!-- A fully fleshed-out <head>, dynamically changing based on client.json and the page front matter -->
<html lang="en">
  <head>
    <!-- View Transitions support -->
    <ClientRouter />

    <!-- Standard meta tags -->
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="keywords" content="" />
    <link
      rel="canonical"
      href={`https://${client.domain}${Astro.url.pathname}`}
    />

    <!-- If present, preloads the image passed as a prop -->
    {
      preloadedImage && (
        <link rel="preload" href={preloadedImage.src} as="image" />
      )
    }

    <!-- Social Media Display - generated automatically with the props passed to BaseLayout -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content={`https://${client.domain}${Astro.url.pathname}`}
    />

    <!-- ✅ FIXED: Proper OG image tags with absolute URLs -->
    {
      ogImageUrl && (
        <>
          <meta property="og:image" content={ogImageUrl} />
          <meta property="og:image:secure_url" content={ogImageUrl} />
        </>
      )
    }
    <link
      rel="preload"
      href="/assets/fonts/lato-v25-latin-regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/assets/fonts/montserrat-v31-latin-700.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- Favicons -->
    <link
      rel="icon"
      type="image/png"
      href="/assets/favicons/favicon-96x96.png"
      sizes="96x96"
    />
    <link rel="icon" type="image/svg+xml" href="/assets/favicons/favicon.svg" />
    <link rel="shortcut icon" href="/assets/favicons/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/assets/favicons/apple-touch-icon.png"
    />
    <link rel="manifest" href="/assets/favicons/site.webmanifest" />

    <!-- For home page, use service keywords for the title, including location for SEO.
    Other pages should just include the page name.
    
    EXAMPLE:
    Home page - House Painting Contractors | Painters and Co. | TestCity, WA
    About Page - About us | Painters and Co.
    -->
    <title>
      {
        Astro.url.pathname === "/"
          ? `${title} | ${client.name} | ${client.address.city}, ${client.address.state}`
          : `${title} | ${client.name}`
      }
    </title>

    <!-- Sitewide Scripts -->
    <script src="@js/nav.js"></script>
  </head>
  <body>
    <!-- Screen reader skip main nav -->
    <a class="skip" aria-label="skip to main content" href="#main"
      >Click To Skip To Main Content</a
    >

    <Header />
    <main id="main">
      <slot />
    </main>
    <Footer />
  </body>
</html>
